longer
at Center B.
Recall from Section 2.3.7 the use of lambda for creating short functions
on the fly. We use the function sim_time() from the ISLP.survival packsim_time()
age. This function uses the relationship between the survival function and
cumulative hazard S(t) = exp(−H(t)) and the specific form of the cumulative hazard function in the Cox model to simulate data based on values
of the linear predictor true_linpred and the cumulative hazard. We need
to provide the cumulative hazard function, which we do here.
In [25]: cum_hazard = lambda t: 1e-5 * t**2 / 2

496

11. Survival Analysis and Censored Data

We are now ready to generate data under the Cox proportional hazards
model. We truncate the maximum time to 1000 seconds to keep simulated
wait times reasonable. The function sim_time() takes a linear predictor, a
cumulative hazard function and a random number generator.
In [26]: W = np.array ([ sim_time(l, cum_hazard , rng)
for l in true_linpred ])
D['Wait time '] = np.clip(W, 0, 1000)

We now simulate our censoring variable, for which we assume 90% of
calls were answered (Failed==1) before the customer hung up (Failed==0).
In [27]: D['Failed '] = rng.choice ([1, 0],
N,
p=[0.9 , 0.1])
D[:5]
Out[27]:

0
1
2
3
4

Operators Center
13
C
15
A
7
B
7
C
13
C

Time
After.
Even.
Morn.
Morn.
Even.

Wait time
525.064979
254.677835
487.739224
308.580292
154.174608

Failed
1
1
1
1
1

In [28]: D['Failed ']. mean ()
Out[28]: 0.8985

We now plot Kaplan-Meier survival curves. First, we stratify by Center.
In [29]: fig , ax = subplots(figsize =(8 ,8))
by_center = {}
for center , df in D.groupby('Center '):
by_center[center] = df
km_center = km.fit(df['Wait time '], df['Failed '])
km_center.plot(label='Center =%s' % center , ax=ax)
ax.set_title("Probability of Still Being on Hold")

Next, we stratify by Time.
In [30]: fig , ax = subplots(figsize =(8 ,8))
by_time = {}
for time , df in D.groupby('Time '):
by_time[time] = df
km_time = km.fit(df['Wait time '], df['Failed '])
km_time.plot(label='Time =%s' % time , ax=ax)
ax.set_title("Probability of Still Being on Hold")

It seems that calls at Call Center B take longer to be answered than calls
at Centers A and C. Similarly, it appears that wait times are longest in the
morning and shortest in the evening hours. We can use a log-rank test to
determine whether these differences are statistically significant using the
function multivariate_logrank_test().
In [31]: multivariate_logrank_test (D['Wait time '],
D['Center '],
D['Failed '])

11.8 Lab: Survival Analysis
Out[31]:

t_0
null_distribution
degrees_of_freedom
test_name

497

-1
chi squared
2
multivariate_logrank_test

test_statistic
p
20.30 <0.005

-log2(p)
14.65

Next, we consider the effect of Time.
In [32]: multivariate_logrank_test (D['Wait time '],
D['Time '],
D['Failed '])
Out[32]:

t_0
null_distribution
degrees_of_freedom
test_name

-1
chi squared
2
multivariate_logrank_test

test_statistic
p
49.90 <0.005

-log2(p)
35.99

As in the case of a categorical variable with 2 levels, these results are
similar to the likelihood ratio test from the Cox proportional hazards model.
First, we look at the results for Center.
In [33]: X = MS(['Wait time ',
'Failed ',
'Center '],
intercept=False).fit_transform(D)
F = coxph ().fit(X, 'Wait time ', 'Failed ')
F. log_likelihood_ratio_test ()
Out[33]: null_distribution
degrees_freedom
test_name

chi squared
2
log -likelihood ratio test

test_statistic
p
20.58 <0.005

-log2(p)
14.85

Next, we look at the results for Time.
In [34]: X = MS(['Wait time ',
'Failed ',
'Time '],
intercept=False).fit_transform(D)
F = coxph ().fit(X, 'Wait time ', 'Failed ')
F. log_likelihood_ratio_test ()
Out[34]: null_distribution
degrees_freedom
test_name

chi squared
2
log -likelihood ratio test

test_statistic
p
48.12 <0.005

-log2(p)
34.71

We find that differences between centers are highly significant, as are
differences between times of day.
Finally, we fit Cox’s proportional hazards model to the data.

498

11. Survival Analysis and Censored Data

In [35]: X = MS(D.columns ,
intercept=False).fit_transform(D)
fit_queuing = coxph ().fit(
X,
'Wait time ',
'Failed ')
fit_queuing.summary [['coef ', 'se(coef)', 'p']]
Out[35]:

covariate
Operators
Center[B]
Center[C]
Time[Even .]
Time[Morn .]

coef

se(coef)

p

0.043934
-0.236059
0.012231
0.268845
-0.148215

0.007520
0.058113
0.057518
0.057797
0.057334

5.143677e-09
4.864734e-05
8.316083e-01
3.294914e-06
9.734378e-03

The p-values for Center B and evening time are very small. It is also
clear that the hazard — that is, the instantaneous risk that a call will be
answered — increases with the number of operators. Since we generated
the data ourselves, we know that the true coefficients for Operators, Center
= B, Center = C, Time = Even. and Time = Morn. are 0.04, −0.3, 0, 0.2, and
−0.2, respectively. The coefficient estimates from the fitted Cox model are
fairly accurate.

11.9

Exercises

Conceptual
1. For each example, state whether or not the censoring mechanism is
independent. Justify your answer.
(a) In a study of disease relapse, due to a careless research scientist,
all patients whose phone numbers begin with the number “2”
are lost to follow up.
(b) In a study of longevity, a formatting error causes all patient ages
that exceed 99 years to be lost (i.e. we know that those patients
are more than 99 years old, but we do not know their exact
ages).
(c) Hospital A conducts a study of longevity. However, very sick
patients tend to be transferred to Hospital B, and are lost to
follow up.
(d) In a study of unemployment duration, the people who find work
earlier are less motivated to stay in touch with study investigators, and therefore are more likely to be lost to follow up.
(e) In a study of pregnancy duration, women who deliver their babies pre-term are more likely to do so away from their usual
hospital, and thus are more likely to be censored, relative to
women who deliver full-term babies.

11.9 Exercises

499

(f) A researcher wishes to model the number of years of education
of the residents of a small town. Residents who enroll in college
out of town are more likely to be lost to follow up, and are
also more likely to attend graduate school, relative to those who
attend college in town.
(g) Researchers conduct a study of disease-free survival (i.e. time
until disease relapse following treatment). Patients who have
not relapsed within five years are considered to be cured, and
thus their survival time is censored at five years.
(h) We wish to model the failure time for some electrical component.
This component can be manufactured in Iowa or in Pittsburgh,
with no difference in quality. The Iowa factory opened five years
ago, and so components manufactured in Iowa are censored at
five years. The Pittsburgh factory opened two years ago, so those
components are censored at two years.
(i) We wish to model the failure time of an electrical component
made in two different factories, one of which opened before the
other. We have reason to believe that the components manufactured in the factory that opened earlier are of higher quality.
2. We conduct a study with n = 4 participants who have just purchased
cell phones, in order to model the time until phone replacement. The
first participant replaces her phone after 1.2 years. The second participant still has not replaced her phone at the end of the two-year
study period. The third participant changes her phone number and is
lost to follow up (but has not yet replaced her phone) 1.5 years into
the study. The fourth participant replaces her phone after 0.2 years.
For each of the four participants (i = 1, . . . , 4), answer the following
questions using the notation introduced in Section 11.1:
(a) Is the participant’s cell phone replacement time censored?
(b) Is the value of ci known, and if so, then what is it?
(c) Is the value of ti known, and if so, then what is it?
(d) Is the value of yi known, and if so, then what is it?
(e) Is the value of δi known, and if so, then what is it?
3. For the example in Exercise 2, report the values of K, d1 , . . . , dK ,
r1 , . . . , rK , and q1 , . . . , qK , where this notation was defined in Section 11.3.
4. This problem makes use of the Kaplan-Meier survival curve displayed
in Figure 11.9. The raw data that went into plotting this survival
curve is given in Table 11.4. The covariate column of that table is
not needed for this problem.
(a) What is the estimated probability of survival past 50 days?

500

11. Survival Analysis and Censored Data

Observation (Y )
26.5
37.2
57.3
90.8
20.2
89.8

Censoring Indicator (δ)
1
1
1
0
0
0

Covariate (X)
0.1
11
-0.3
2.8
1.8
0.4

TABLE 11.4. Data used in Exercise 4.

(b) Write out an analytical expression for the estimated survival
function. For instance, your answer might be something along
the lines of


if t < 31
0.8
W = 0.5
S(t)
if 31 ≤ t < 77


0.22 if 77 ≤ t.
(The previous equation is for illustration only: it is not the correct answer!)

5. Sketch the survival function given by the equation


if t < 31
0.8
W
S(t) = 0.5
if 31 ≤ t < 77


0.22 if 77 ≤ t.
1.0
0.8
0.6
0.4
0.2
0.0

Estimated Probability of Survival

Your answer should look something like Figure 11.9.

0

20

40

60

80

Time in Days

FIGURE 11.9. A Kaplan-Meier survival curve used in Exercise 4.

6. This problem makes use of the data displayed in Figure 11.1. In
completing this problem, you can refer to the observation times as
y1 , . . . , y4 . The ordering of these observation times can be seen from
Figure 11.1; their exact values are not required.
(a) Report the values of δ1 , . . . , δ4 , K, d1 , . . . , dK , r1 , . . . , rK , and
q1 , . . . , qK . The relevant notation is defined in Sections 11.1 and
11.3.

11.9 Exercises

501

(b) Sketch the Kaplan-Meier survival curve corresponding to this
data set. (You do not need to use any software to do this — you
can sketch it by hand using the results obtained in (a).)
(c) Based on the survival curve estimated in (b), what is the probability that the event occurs within 200 days? What is the probability that the event does not occur within 310 days?
(d) Write out an expression for the estimated survival curve from
(b).
7. In this problem, we will derive (11.5) and (11.6), which are needed
for the construction of the log-rank test statistic (11.8). Recall the
notation in Table 11.1.
(a) Assume that there is no difference between the survival functions
of the two groups. Then we can think of q1k as the number of
failures if we draw r1k observations, without replacement, from
a risk set of rk observations that contains a total of qk failures.
Argue that q1k follows a hypergeometric distribution. Write the
hyperparameters of this distribution in terms of r1k , rk , and qk .
geometric
(b) Given your previous answer, and the properties of the hyper- distribution
geometric distribution, what are the mean and variance of q1k ?
Compare your answer to (11.5) and (11.6).
8. Recall that the survival function S(t), the hazard function h(t), and
the density function f (t) are defined in (11.2), (11.9), and (11.11),
respectively. Furthermore, define F (t) = 1 − S(t). Show that the
following relationships hold:
f (t) =
S(t) =

dF (t)/dt
* L t
+
exp −
h(u)du .
0

9. In this exercise, we will explore the consequences of assuming that
the survival times follow an exponential distribution.
(a) Suppose that a survival time follows an Exp(λ) distribution,
so that its density function is f (t) = λ exp(−λt). Using the
relationships provided in Exercise 8, show that S(t) = exp(−λt).
(b) Now suppose that each of n independent survival times follows
an Exp(λ) distribution. Write out an expression for the likelihood function (11.13).
(c) Show that the maximum likelihood estimator for λ is
λ̂ =

n
0
i=1

δi /

n
0

yi .

i=1

(d) Use your answer to (c) to derive an estimator of the mean survival time.
Hint: For (d), recall that the mean of an Exp(λ) random variable is
1/λ.

502

11. Survival Analysis and Censored Data

Applied
10. This exercise focuses on the brain tumor data, which is included in
the ISLP library.
(a) Plot the Kaplan-Meier survival curve with ±1 standard error
bands, using the KaplanMeierFitter() estimator in the lifelines
package.
(b) Draw a bootstrap sample of size n = 88 from the pairs (yi , δi ),
and compute the resulting Kaplan-Meier survival curve. Repeat
this process B = 200 times. Use the results to obtain an estimate
of the standard error of the Kaplan-Meier survival curve at each
timepoint. Compare this to the standard errors obtained in (a).
(c) Fit a Cox proportional hazards model that uses all of the predictors to predict survival. Summarize the main findings.
(d) Stratify the data by the value of ki. (Since only one observation
has ki==40, you can group that observation together with the observations that have ki==60.) Plot Kaplan-Meier survival curves
for each of the five strata, adjusted for the other predictors.
11. This exercise makes use of the data in Table 11.4.
(a) Create two groups of observations. In Group 1, X < 2, whereas
in Group 2, X ≥ 2. Plot the Kaplan-Meier survival curves corresponding to the two groups. Be sure to label the curves so that
it is clear which curve corresponds to which group. By eye, does
there appear to be a difference between the two groups’ survival
curves?
(b) Fit Cox’s proportional hazards model, using the group indicator
as a covariate. What is the estimated coefficient? Write a sentence providing the interpretation of this coefficient, in terms
of the hazard or the instantaneous probability of the event. Is
there evidence that the true coefficient value is non-zero?
(c) Recall from Section 11.5.2 that in the case of a single binary
covariate, the log-rank test statistic should be identical to the
score statistic for the Cox model. Conduct a log-rank test to determine whether there is a difference between the survival curves
for the two groups. How does the p-value for the log-rank test
statistic compare to the p-value for the score statistic for the
Cox model from (b)?

12
Unsupervised Learning

Most of this book concerns supervised learning methods such as
regression and classification. In the supervised learning setting, we typically
have access to a set of p features X1 , X2 , . . . , Xp , measured on n observations, and a response Y also measured on those same n observations.
The goal is then to predict Y using X1 , X2 , . . . , Xp .
This chapter will instead focus on unsupervised learning, a set of statistical tools intended for the setting in which we have only a set of features X1 , X2 , . . . , Xp measured on n observations. We are not interested
in prediction, because we do not have an associated response variable Y .
Rather, the goal is to discover interesting things about the measurements
on X1 , X2 , . . . , Xp . Is there an informative way to visualize the data? Can
we discover subgroups among the variables or among the observations?
Unsupervised learning refers to a diverse set of techniques for answering
questions such as these. In this chapter, we will focus on two particular types of unsupervised learning: principal components analysis, a tool
used for data visualization or data pre-processing before supervised techniques are applied, and clustering, a broad class of methods for discovering
unknown subgroups in data.

12.1

The Challenge of Unsupervised Learning

Supervised learning is a well-understood area. In fact, if you have read
the prece